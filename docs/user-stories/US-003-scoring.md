# US-003: Команды и подсчёт очков (event-sourcing)

## Описание

**Как** ведущий, **я хочу** выбирать команду и засчитывать ответы, **чтобы** табло считало баллы корректно.

## Acceptance Criteria

- ✅ **Источник истины — `score_events`** (локально в MVP), табло = сумма `delta`
- ✅ **Вопрос после зачёта помечается `done`** и недоступен повторно
- ✅ **Экспорт результатов в CSV** (время, questionId, teamId, delta)

## Реализованные функции

### 1. Event-Sourcing модель

**Файл:** `src/shared/gameStore.ts`

- Реализована модель `ScoreEvent` для хранения всех событий очков
- Табло рассчитывается как сумма `delta` из `score_events`
- Каждое событие содержит: `id`, `gameId`, `teamId`, `questionId`, `delta`, `createdAt`

```typescript
interface ScoreEvent {
  id: string
  gameId: string
  teamId: string
  questionId: string
  delta: number
  createdAt: string
}
```

### 2. Кнопки "Верно/Неверно"

**Файл:** `src/components/HostPanel.tsx`

- Добавлены кнопки "Верно" и "Неверно" в интерфейс пульта ведущего
- Кнопки активны только при выбранной команде и открытом вопросе
- При нажатии создается `ScoreEvent` с соответствующим `delta`

### 3. Обновленное табло

**Файл:** `src/components/Scoreboard.tsx`

- Табло отображает сумму очков из `score_events` для каждой команды
- Использует функцию `getTeamScore(teamId)` для расчета очков
- Поддерживает отрицательные очки (неправильные ответы)

### 4. Экспорт результатов в CSV

**Файлы:** 
- `src/shared/exportUtils.ts` - утилиты экспорта
- `src/components/HostPanel.tsx` - кнопка экспорта

#### Функции экспорта:

- `exportToCSV(data)` - генерирует CSV с метаданными и данными
- `downloadCSV(content, filename)` - скачивает файл в браузере
- `generateExportFilename(title, date)` - создает имя файла

#### Формат CSV:

```csv
# Экспорт результатов игры: Демо-игра Jeopardy
# Дата экспорта: 2024-01-01T12:00:00.000Z
# Всего событий: 3
# Всего команд: 3

"Время","ID Вопроса","Текст Вопроса","Стоимость","ID Команды","Название Команды","Дельта","Правильный Ответ"
"2024-01-01T10:00:00.000Z","q-1-1","В каком году началась Вторая мировая война?","100","team-1","Команда 1","100","1939"
```

### 5. Аналитика

**Файл:** `src/shared/analytics.ts`

- Добавлено событие `export_results` для отслеживания экспорта
- Отправляется при каждом экспорте с количеством событий

## Тесты

### Unit тесты

**Файлы:**
- `src/shared/__tests__/exportUtils.test.ts` - тесты утилит экспорта
- `src/shared/__tests__/gameStore-export.test.ts` - тесты функциональности экспорта

**Покрытие:**
- ✅ Генерация CSV с правильными заголовками и метаданными
- ✅ Обработка отсутствующих данных команд/вопросов
- ✅ Сортировка событий по времени
- ✅ Генерация имен файлов
- ✅ Экспорт множественных событий
- ✅ Расчет очков команд

### E2E тесты

**Файл:** `tests/e2e/export-functionality.spec.ts`

**Покрытие:**
- ✅ Экспорт результатов после ответов на вопросы
- ✅ Отображение кнопки экспорта
- ✅ Скачивание CSV файла
- ✅ Правильный формат имени файла

## Горячие клавиши

- **C** - Верно (правильный ответ)
- **X** - Неверно (неправильный ответ)
- **A** - Показать/скрыть ответ
- **Esc** - Назад к полю

## Технические детали

### Event-Sourcing архитектура

1. **Источник истины:** `score_events` массив в gameStore
2. **Расчет очков:** `getTeamScore(teamId)` суммирует `delta` для команды
3. **Персистентность:** Состояние сохраняется в localStorage через Zustand persist
4. **События:** Каждое действие создает событие с timestamp

### Экспорт данных

1. **Формат:** CSV с UTF-8 кодировкой
2. **Метаданные:** Заголовок с информацией об игре
3. **Данные:** Все события с полной информацией
4. **Имя файла:** `jeopardy_{gameTitle}_{date}_{time}.csv`

### Безопасность

- Экспорт доступен только на странице пульта ведущего
- Файлы скачиваются локально, не передаются на сервер
- Все данные остаются в браузере пользователя

## Совместимость

- ✅ **Браузеры:** Chrome, Firefox, Safari, Edge
- ✅ **Мобильные:** Responsive дизайн
- ✅ **Экспорт:** Работает во всех современных браузерах

## Производительность

- **Расчет очков:** O(n) где n - количество событий
- **Экспорт:** O(n) где n - количество событий
- **Память:** События хранятся в памяти, ограничено localStorage

## Будущие улучшения

1. **Экспорт в другие форматы:** JSON, Excel
2. **Фильтрация экспорта:** по командам, датам, вопросам
3. **Статистика:** графики, диаграммы
4. **Облачный экспорт:** сохранение в облако
5. **Печать:** экспорт для печати

## Заключение

US-003 полностью реализован согласно требованиям:

- ✅ Event-sourcing модель для очков
- ✅ Кнопки "Верно/Неверно" с правильной логикой
- ✅ Табло на основе суммы событий
- ✅ Экспорт в CSV с полными данными
- ✅ Комплексное тестирование
- ✅ Аналитика и мониторинг

Функциональность готова к использованию и может быть расширена в будущих версиях.
